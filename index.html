<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>The Human Body - Learning Game</title>
<style>
  /* ====== Reset & base ====== */
  * { box-sizing: border-box; margin:0; padding:0; }
  :root{
    --blue:#001DFF;
    --blue-dark:#04032B;
    --blue-700:#1a3a5f;
    --blue-600:#254fba;
    --orange:#f59e42;
    --orange-700:#e67e22;
    --bg-grad-1:#1a3a5f;
    --bg-grad-2:#0d2340;
    --white:#ffffff;
    --green:#2ecc71;
    --red:#e74c3c;
    --panel:#E8EAFF;
  }
  body{
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, var(--bg-grad-1) 0%, var(--bg-grad-2) 100%);
    min-height:100vh; display:flex; justify-content:center; align-items:center; color:#333; padding:10px;
  }
  .game-container{
    background:var(--white); border-radius:16px; box-shadow:0 12px 24px rgba(0,0,0,.12);
    padding:1.2rem; max-width:980px; width:100%; min-height:640px; position:relative; overflow:hidden;
    display:flex; flex-direction:column;
  }
  header{ text-align:center; margin-bottom:.8rem; margin-top:2rem; }
  h1{ color:var(--blue-dark); font-size:clamp(2rem,5.2vw,3.1rem); font-weight:900; letter-spacing:.5px; }
  .subtitle{ color:var(--blue-700); font-size:clamp(1rem,3.5vw,1.25rem); margin-top:.25rem; }
  .highlight-keyword{ color:var(--orange); font-weight:800; }

  .btn{ color:#fff; border:none; padding:.75rem 1.2rem; border-radius:10px; cursor:pointer; font-weight:800;
        transition:transform .08s ease, box-shadow .2s ease, background-color .25s ease; min-width:140px; height:48px;
        display:inline-flex; align-items:center; justify-content:center; }
  .btn:hover{ transform:translateY(-2px); box-shadow:0 6px 14px rgba(0,0,0,.12); }
  .btn:active{ transform:translateY(0); }
  .btn-primary{ background:var(--orange); }
  .btn-primary:hover{ background:var(--orange-700); }
  .btn-blue{ background:var(--blue-600); }
  .btn-blue:hover{ filter:brightness(.9); }
  .btn-ghost{ background:#e6f2ff; color:var(--blue-700); }

  .screen{ display:none; animation:fadeIn .35s ease; }
  .screen.active{ display:block; }
  @keyframes fadeIn{ from{opacity:0; transform:translateY(12px);} to{opacity:1; transform:translateY(0);} }

  .game-info{ display:flex; gap:.6rem; align-items:center; justify-content:space-between; margin:.4rem 0 1rem; flex-wrap:wrap; }
  .timer{ font-weight:900; color:var(--blue-700); font-size:clamp(.95rem,2.3vw,1.15rem); }
  .progress-bar{ flex:1; height:10px; background:#e6f2ff; border-radius:999px; overflow:hidden; }
  .progress-fill{ height:100%; width:0%; background:linear-gradient(90deg, var(--orange) 0%, var(--orange-700) 100%); transition:width .3s ease; }
  .score{ font-weight:900; color:var(--blue-700); font-size:clamp(.9rem,2.3vw,1.1rem); }

  .start-content{ display:flex; flex-direction:column; justify-content:center; align-items:center; flex:1; gap:1rem; padding:1rem; }
  .advice-box{ background:var(--panel); border-left:4px solid var(--blue-700); padding:1rem 1.2rem; border-radius:12px;
               color:var(--blue-700); max-width:760px; text-align:center; font-size:clamp(1rem,3vw,1.15rem); }
  .start-image{ max-width: 300px; width: 100%; margin: 0 auto; }

  .mute-btn{ position:absolute; top:.8rem; right:4.5rem; background:var(--orange); color:#fff; border:2px solid #fff; width:38px; height:38px; border-radius:50%; cursor:pointer; font-size:1rem; display:flex; align-items:center; justify-content:center; z-index:20; }
  .mute-btn:hover{ background:var(--orange-700); }

  .word-bank {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    margin: 20px 0;
    min-height: 80px;
    background: #f8f9fa;
    border-radius: 10px;
    padding: 15px;
    border: 2px dashed #ccc;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }

  .word-bank.drag-over {
    border-color: var(--blue);
    background: var(--panel);
  }

  .word-item {
    background-color: #9b59b6;
    color: white;
    padding: 12px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    min-width: 100px;
    text-align: center;
    user-select: none;
    transition: background-color 0.2s ease, transform 0.2s ease;
    border: 2px solid transparent;
  }

  .word-item:hover {
    transform: scale(1.05);
  }

  .word-item.selected {
    background-color: var(--orange);
    box-shadow: 0 0 10px var(--orange);
  }

  .classification-areas {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin: 20px 0;
  }

  .classification-area {
    background-color: white;
    border: 2px dashed #a9cce3;
    border-radius: 8px;
    padding: 15px;
    min-height: 120px;
    cursor: pointer;
    transition: border-color 0.2s ease, background-color 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }

  .classification-area:hover {
    border-color: #2980b9;
  }

  .classification-area.drag-over {
    background-color: #e8f4fc;
    border-color: #3498db;
  }

  .classification-area h4 {
    color: #2980b9;
    margin-bottom: 10px;
    font-size: 1.1rem;
  }

  .classification-item {
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.9rem;
    background-color: #8e44ad;
    color: #fff;
    cursor: pointer;
    user-select: none;
    min-width: 90px;
    text-align: center;
    transition: background-color 0.2s ease, transform 0.2s ease;
    margin: 5px;
    display: inline-block;
  }

  .classification-item:hover {
    background-color: #732d91;
  }

  .classification-item.correct {
    background-color: var(--green);
  }

  .classification-item.incorrect {
    background-color: var(--red);
  }

  .results{ display:flex; flex-direction:column; align-items:center; gap:.6rem; text-align:center; min-height:calc(100vh - 180px); }
  .final-title{ color:var(--blue-dark); font-weight:900; }
  .big-score{ font-size:clamp(2.2rem,6vw,3.4rem); color:var(--blue-600); font-weight:900; }
  .score-title{ font-size:1.0rem; color:var(--blue-700); margin-top:1rem; }
  .final-time{ color:var(--blue-700); }
  .trophy{ font-size:clamp(4rem,10vw,6rem); margin:.2rem 0; color:var(--orange); animation:bounce 1s ease infinite; }
  @keyframes bounce { 0%,100%{ transform:translateY(0);} 50%{ transform:translateY(-8px);} }
  .credit{ color:var(--blue-700); margin-top:1rem; }

  /* Tama√±o del mensaje final (un poco menor que el t√≠tulo final) */
  #finalMsg {
    font-size: clamp(1.6rem, 3.8vw, 2.4rem);
    font-weight: 800;
    color: var(--blue-700);
    margin-top: 0.6rem;
  }

  /* Estilos para el logo del colegio en la pantalla final */
  .school-logo {
    display: block;
    width: 160px;       /* ancho por defecto en pantallas grandes */
    max-width: 28%;     /* evita que crezca demasiado en pantallas muy anchas */
    height: auto;
    margin-top: 0.8rem;
    border-radius: 8px; /* opcional, suaviza esquinas si la imagen lo permite */
    object-fit: contain;
  }

  /* Ajustes responsivos para m√≥viles */
  @media (max-width: 899px) {
    .school-logo { width: 140px; max-width: 160px; }
  }
  @media (max-width: 420px) {
    .school-logo { width: 110px; max-width: 40%; margin-top: 0.6rem; }
    .results { gap: 0.4rem; padding: 0 0.6rem; }
    #finalMsg { font-size: clamp(1.2rem, 4.2vw, 1.8rem); }
    .big-score { font-size: clamp(1.8rem, 6vw, 2.6rem); }
  }
  @media (max-width: 320px) {
    .school-logo { width: 90px; max-width: 48%; }
    #finalMsg { font-size: clamp(1.1rem, 4.6vw, 1.6rem); }
  }

  .confetti{ position:fixed; width:10px; height:10px; border-radius:50%; animation: confetti-fall 3s linear forwards; z-index:999; }
  @keyframes confetti-fall{ 0%{ transform:translate(0, -20px) rotate(0); opacity:1;} 100%{ transform:translate(var(--tx), var(--ty)) rotate(360deg); opacity:0; } }

  .hidden {
    display: none;
  }

  .theory-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
  }

  .theory-content {
    background-color: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    border-left: 5px solid var(--blue);
  }

  .theory-english {
    color: #333;
    font-size: 1.1rem;
    line-height: 1.6;
    margin-bottom: 20px;
  }

  .theory-spanish {
    color: #666;
    font-size: 1rem;
    line-height: 1.5;
    font-style: italic;
  }

  .theory-english strong {
    color: var(--blue);
    font-weight: bold;
  }

  .game-instruction {
    font-size: 1.5rem;
    color: var(--blue);
    margin: 20px 0;
    font-weight: bold;
    text-align: center;
  }

  @media (min-width:900px){ .board{ grid-template-columns: 360px 1fr; align-items:start; } .panel{ order:1; } .stage{ order:2; } }
  @media (max-width:899px){
    header{ margin-top:1.6rem; }
    .board{ grid-template-columns:1fr; }
    .panel{ display:flex; flex-direction:row; align-items:center; justify-content:center; padding:.6rem; }
    .word-display-container{ order:0; width:100%; margin-bottom:.6rem; }
    .stage{ order:1; }
  }
  @media (max-width:420px){ .btn{ min-width:110px; padding:.6rem .9rem; height:44px; } }

  .marker.clicked-temp { transform: translate(-50%, -50%) scale(.95); transition: transform .12s ease; }

  /* Nuevo estilo para el consejo, centrado y en dos l√≠neas */
  .advice-box .advice-text {
      display: block;
  }
  .advice-box strong {
      display: block;
      margin-top: 0.5rem;
      text-align: center;
  }
</style>
</head>
<body>
<div class="game-container">
  <button class="mute-btn" id="muteBtn" title="Silenciar/Activar sonido">üîä</button>

  <!-- Main Menu Screen -->
  <section class="screen active" id="startScreen" aria-labelledby="title">
    <header>
      <h1 id="title">The Human Body</h1>
      <div class="subtitle">Classify the parts of the body</div>
    </header>
    <div class="start-content">
      <div class="advice-box" role="note" aria-live="polite">
        <span class="advice-text">Put the <span class="highlight-keyword">parts of the body</span> into the correct box.</span>
        <strong>Good luck!</strong>
      </div>
      <button class="btn btn-primary" id="playBtn">Start Learning</button>
      <img class="start-image" src="https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/main/Ni%C3%B1os.png" alt="Children Learning">
    </div>
  </section>

  <!-- Theory Screen -->
  <section class="screen" id="theoryScreen">
    <div class="theory-container">
      <h1 class="title">The Human Body</h1>
      <div class="theory-content">
        <div class="theory-english">
          <strong>THE HUMAN BODY</strong><br>
          Humans are mammals. We are different from animals because we can think and speak.<br>
          We are composed of three parts: <strong>head, trunk and limbs</strong>:<br>
          ‚Ä¢ <strong>Head</strong>: eyes, ears, nose, mouth, hair.<br>
          ‚Ä¢ <strong>Torso</strong>: chest, neck, belly button.<br>
          ‚Ä¢ <strong>Limbs</strong>: upper limbs and lower limbs:<br>
          &nbsp;&nbsp;‚Ä¢ <strong>Upper limbs</strong>: arm, hand.<br>
          &nbsp;&nbsp;‚Ä¢ <strong>Lower limbs</strong>: leg, knee and foot.
        </div>
        <div class="theory-spanish">
          <strong>El cuerpo humano</strong><br>
          Los humanos son mam√≠feros. Somos diferentes de los animales porque podemos pensar y hablar.<br>
          Estamos compuestos por tres partes: <strong>cabeza, tronco y extremidades</strong>:<br>
          ‚Ä¢ <strong>Cabeza</strong>: ojos, orejas, nariz, boca, cabello.<br>
          ‚Ä¢ <strong>Torso</strong>: pecho, cuello, ombligo.<br>
          ‚Ä¢ <strong>Extremidades</strong>: extremidades superiores e inferiores:<br>
          &nbsp;&nbsp;‚Ä¢ <strong>Extremidades superiores</strong>: brazo, mano.<br>
          &nbsp;&nbsp;‚Ä¢ <strong>Extremidades inferiores</strong>: pierna, rodilla y pie.
        </div>
      </div>
      <div style="text-align: center;">
        <button class="btn btn-primary" id="startGameBtn">Play</button>
      </div>
    </div>
  </section>

  <!-- Game Screen -->
  <section class="screen" id="gameScreen">
    <div class="game-container">
      <header>
        <h1 class="title">The Human Body</h1>
      </header>
      <div class="game-info">
        <div class="timer" id="timer">00:00</div>
        <div class="progress-bar" aria-label="Progreso"><div class="progress-fill" id="progressFill"></div></div>
        <div class="score">Score: <span id="score">0</span>/100</div>
      </div>
      <div class="game-instruction" id="gameInstruction">Classify the body parts.</div>
      <div id="gameContent"></div>
      <div id="gameButtons" style="text-align: center; margin-top: 20px;"></div>
    </div>
  </section>

  <!-- Final Screen -->
  <section class="screen" id="resultsScreen">
    <header>
      <h1 class="final-title">The Human Body</h1>
    </header>
    <div class="results">
      <div id="trophyBox" style="display:none;">
        <div class="trophy">üèÜ</div>
      </div>
      <div class="score-title">Your score:</div>
      <div class="big-score" id="finalScore">0</div>
      <div class="final-time">Time: <span id="finalTime">00:00</span></div>
      <div id="finalMsg" class="subtitle"></div>
      <button class="btn btn-primary" id="backToMenuBtn" style="background:var(--orange);">Back to menu</button>
      <span class="credit">Created by Manuel J. Ventura</span>
      <img class="school-logo" src="https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/main/Siurot.png" alt="School Logo" />
    </div>
  </section>
</div>

<script>
// Audio setup
let soundEnabled = true;
let audioUnlocked = false;
const audioUrls = {
  correct: 'https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/7b86808e254100aeaba6285b3e0b82650ae78055/Correcto.mp3',
  error: 'https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/7b86808e254100aeaba6285b3e0b82650ae78055/Error.mp3',
  completed: 'https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/7b86808e254100aeaba6285b3e0b82650ae78055/Completado.mp3',
  victory: 'https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/7b86808e254100aeaba6285b3e0b82650ae78055/Termin%C3%A9.mp3',
  tap: 'https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/37b3eb2da9c15c04dfb71dfe1be60f088ea3cdfc/Tap.mp3'
};

const audioObjects = {};

// Create audio instances
Object.keys(audioUrls).forEach(key => {
  audioObjects[key] = new Audio(audioUrls[key]);
  audioObjects[key].preload = 'auto';
  audioObjects[key].volume = 1.0;
});

// Funci√≥n para desbloquear el audio
function unlockAudio() {
  if (audioUnlocked) return;
  
  // Intentar desbloquear el audio con un sonido silencioso
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = ctx.createOscillator();
    const gainNode = ctx.createGain();
    oscillator.connect(gainNode);
    gainNode.connect(ctx.destination);
    gainNode.gain.value = 0.001; // Volumen muy bajo
    oscillator.start();
    oscillator.stop(ctx.currentTime + 0.01);
    
    // Tambi√©n intentar reproducir el audio del tap
    audioObjects['tap'].play().then(() => {
      audioObjects['tap'].pause();
      audioObjects['tap'].currentTime = 0;
    }).catch(e => console.log("Audio unlock failed:", e));
    
    audioUnlocked = true;
  } catch (e) {
    console.warn("Web Audio API no disponible:", e);
    audioUnlocked = true;
  }
}

function playSound(soundType) {
  if (!soundEnabled || !audioObjects[soundType]) return;

  try {
    const audio = audioObjects[soundType];
    audio.currentTime = 0;
    
    // Si es la primera vez, intentar desbloquear el audio primero
    if (!audioUnlocked) {
      unlockAudio();
    }
    
    const playPromise = audio.play();
    
    if (playPromise !== undefined) {
      playPromise.then(_ => {
        // Reproducci√≥n exitosa
      }).catch(error => {
        console.log(`Audio play failed for ${soundType}:`, error);
      });
    }
  } catch (error) {
    console.log(`Audio error for ${soundType}:`, error);
  }
}

function toggleSound() {
  soundEnabled = !soundEnabled;
  document.getElementById('muteBtn').textContent = soundEnabled ? 'üîä' : 'üîá';
}

document.getElementById('muteBtn').onclick = toggleSound;

// Game state
let correctAnswers = 0;
let totalQuestions = 0;
let gameData = {};
let gameStartTime = 0;
let timerInterval = null;

// Game definition
const game = {
  title: 'The Human Body',
  instruction: 'Classify the body parts.',
  type: 'classification',
  words: ['eyes', 'ears', 'nose', 'mouth', 'hair', 'chest', 'neck', 'belly button', 'arm', 'hand', 'leg', 'knee', 'foot'],
  categories: {
    'Head': ['eyes', 'ears', 'nose', 'mouth', 'hair'],
    'Torso': ['chest', 'neck', 'belly button'],
    'Upper limbs': ['arm', 'hand'],
    'Lower limbs': ['leg', 'knee', 'foot']
  }
};

// Timer functions
function startTimer() {
  gameStartTime = Date.now();
  timerInterval = setInterval(updateTimer, 1000);
}

function stopTimer() {
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
}

function updateTimer() {
  const elapsed = Math.floor((Date.now() - gameStartTime) / 1000);
  const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
  const seconds = (elapsed % 60).toString().padStart(2, '0');
  document.getElementById('timer').textContent = `${minutes}:${seconds}`;
}

function formatTime(seconds) {
  const minutes = Math.floor(seconds / 60).toString().padStart(2, '0');
  const secs = (seconds % 60).toString().padStart(2, '0');
  return `${minutes}:${secs}`;
}

// Screen management
function showScreen(screenId) {
  document.querySelectorAll('.screen').forEach(screen => {
    screen.classList.remove('active');
  });
  document.getElementById(screenId).classList.add('active');
}

function showTheory() {
  showScreen('theoryScreen');
}

function startGame() {
  correctAnswers = 0;
  totalQuestions = game.words.length;

  showScreen('gameScreen');
  startTimer();
  loadGame();
}

function loadGame() {
  document.getElementById('gameInstruction').textContent = game.instruction;
  updateProgress(0);

  const shuffledWords = [...game.words].sort(() => Math.random() - 0.5);

  let gameContent = `
    <div class="word-bank" id="wordBank">
      ${shuffledWords.map(word =>
        `<div class="word-item" draggable="true" data-word="${word}">${word}</div>`
      ).join('')}
    </div>
    <div class="classification-areas">
      ${Object.keys(game.categories).map(category => `
        <div class="classification-area" data-category="${category}">
          <h4>${category}</h4>
          <div class="category-items" id="category-${category}"></div>
        </div>
      `).join('')}
    </div>
  `;

  document.getElementById('gameContent').innerHTML = gameContent;
  document.getElementById('gameButtons').innerHTML = '<button class="btn btn-primary" onclick="checkClassification()">Check</button>';

  gameData.selectedWord = null;
  gameData.categories = game.categories;
  gameData.answers = {};
  gameData.allWords = [...game.words];

  // Add event listeners
  setupClassificationEvents();
}

function setupClassificationEvents() {
  // Word bank events
  const wordBank = document.getElementById('wordBank');

  // Bank drop events
  wordBank.ondragover = (e) => {
    e.preventDefault();
    wordBank.classList.add('drag-over');
  };

  wordBank.ondragleave = () => {
    wordBank.classList.remove('drag-over');
  };

  wordBank.ondrop = (e) => {
    e.preventDefault();
    wordBank.classList.remove('drag-over');
    const word = e.dataTransfer.getData('text/plain');
    if (word) {
      returnWordToBank(word);
    }
  };

  // Word items events
  document.querySelectorAll('#wordBank .word-item').forEach(item => {
    item.onclick = () => selectWord(item);

    item.ondragstart = (e) => {
      e.dataTransfer.setData('text/plain', item.dataset.word);
      gameData.draggedWord = item.dataset.word;
    };
  });

  // Classification areas events
  document.querySelectorAll('.classification-area').forEach(area => {
    area.onclick = (e) => {
      if (e.target === area || e.target.tagName === 'H4' || e.target.classList.contains('category-items')) {
        placeWord(area.dataset.category);
      }
    };

    area.ondragover = (e) => {
      e.preventDefault();
      area.classList.add('drag-over');
    };

    area.ondragleave = () => {
      area.classList.remove('drag-over');
    };

    area.ondrop = (e) => {
      e.preventDefault();
      area.classList.remove('drag-over');
      const word = e.dataTransfer.getData('text/plain');
      if (word) {
        gameData.selectedWord = word;
        placeWord(area.dataset.category);
      }
    };
  });
}

function selectWord(element) {
  playSound('tap');

  document.querySelectorAll('.word-item, .classification-item').forEach(item => {
    item.classList.remove('selected');
  });

  element.classList.add('selected');
  gameData.selectedWord = element.dataset.word;
}

function placeWord(category) {
  if (!gameData.selectedWord) return;

  playSound('tap');

  const wordToPlace = gameData.selectedWord;

  // Remove from current location
  removeWordFromCurrentLocation(wordToPlace);

  // Add to new category
  addWordToCategory(wordToPlace, category);

  // Store answer and clear selection
  gameData.answers[wordToPlace] = category;
  gameData.selectedWord = null;

  document.querySelectorAll('.word-item, .classification-item').forEach(item => {
    item.classList.remove('selected');
  });
}

function removeWordFromCurrentLocation(word) {
  // Remove from word bank
  const bankItem = document.querySelector(`#wordBank [data-word="${word}"]`);
  if (bankItem) {
    bankItem.remove();
  }

  // Remove from categories
  document.querySelectorAll('.classification-item').forEach(item => {
    if (item.dataset.word === word) {
      delete gameData.answers[word];
      item.remove();
    }
  });
}

function addWordToCategory(word, category) {
  const categoryContainer = document.getElementById(`category-${category}`);
  const wordElement = document.createElement('div');
  wordElement.className = 'classification-item';
  wordElement.textContent = word;
  wordElement.dataset.word = word;
  wordElement.draggable = true;

  wordElement.onclick = () => returnWordToBank(word);

  wordElement.ondragstart = (e) => {
    e.dataTransfer.setData('text/plain', word);
    gameData.draggedWord = word;
  };

  categoryContainer.appendChild(wordElement);
}

function returnWordToBank(word) {
  playSound('tap');

  // Remove from category
  document.querySelectorAll('.classification-item').forEach(item => {
    if (item.dataset.word === word) {
      delete gameData.answers[word];
      item.remove();
    }
  });

  // Add back to bank
  const wordBank = document.getElementById('wordBank');
  const wordElement = document.createElement('div');
  wordElement.className = 'word-item';
  wordElement.textContent = word;
  wordElement.dataset.word = word;
  wordElement.draggable = true;

  wordElement.onclick = () => selectWord(wordElement);

  wordElement.ondragstart = (e) => {
    e.dataTransfer.setData('text/plain', word);
    gameData.draggedWord = word;
  };

  wordBank.appendChild(wordElement);
}

function checkClassification() {
  playSound('completed');

  let correct = 0;

  Object.keys(gameData.answers).forEach(word => {
    const userCategory = gameData.answers[word];
    const correctCategory = Object.keys(gameData.categories).find(cat =>
      gameData.categories[cat].includes(word)
    );

    const categoryContainer = document.getElementById(`category-${userCategory}`);
    if (categoryContainer) {
      const elements = categoryContainer.querySelectorAll('.classification-item');
      elements.forEach(element => {
        if (element.dataset.word === word) {
          if (userCategory === correctCategory) {
            element.classList.add('correct');
            correct++;
          } else {
            element.classList.add('incorrect');
          }
        }
      });
    }
  });

  correctAnswers += correct;

  // Disable interactions
  document.querySelectorAll('.word-item, .classification-item, .classification-area').forEach(item => {
    item.onclick = null;
    item.draggable = false;
    item.style.pointerEvents = 'none';
  });
  document.getElementById('wordBank').ondrop = null;
  document.getElementById('wordBank').ondragover = null;

  document.getElementById('gameButtons').innerHTML = '';
  updateProgress(100);

  setTimeout(() => {
    showFinalScreen();
  }, 2000);
}

function updateProgress(percentage) {
  document.getElementById('progressFill').style.width = percentage + '%';
  document.getElementById('score').textContent = Math.round(percentage);
}

function showFinalScreen() {
  stopTimer();

  const finalScore = Math.round((correctAnswers / totalQuestions) * 100);
  const elapsedSeconds = Math.floor((Date.now() - gameStartTime) / 1000);
  const timeStr = formatTime(elapsedSeconds);

  document.getElementById('finalScore').textContent = finalScore;
  document.getElementById('finalTime').textContent = timeStr;

  if (finalScore === 100) {
    document.getElementById('trophyBox').style.display = 'block';
    document.getElementById('finalMsg').textContent = 'Excellent! Perfect score!';
    playSound('victory');
    createConfetti();
  } else {
    document.getElementById('trophyBox').style.display = 'none';
    document.getElementById('finalMsg').textContent = 'Well done! Keep practising!';
    playSound('completed');
  }

  showScreen('resultsScreen');
}

function createConfetti() {
  for(let i=0;i<120;i++){
    setTimeout(()=>{
      const c=document.createElement('div');
      c.className='confetti';
      const x=Math.random()*window.innerWidth;
      const ty=window.innerHeight+20;
      const tx=(Math.random()-.5)*160;
      const colors=['#ff595e','#1982c4','#6a4c93','#ffca3a','#8ac926','#ff924c','#00c2ff'];
      c.style.left=x+'px';
      c.style.top='-10px';
      c.style.backgroundColor=colors[Math.floor(Math.random()*colors.length)];
      const size=6+Math.random()*8;
      c.style.width=size+'px';
      c.style.height=size+'px';
      c.style.setProperty('--tx', tx+'px');
      c.style.setProperty('--ty', ty+'px');
      document.body.appendChild(c);
      setTimeout(()=>c.remove(), 3200);
    }, i*18);
  }
}

function backToMenu() {
  stopTimer();
  showScreen('startScreen');

  correctAnswers = 0;
  totalQuestions = 0;
  gameData = {};
}

// Initialize the app
document.addEventListener('DOMContentLoaded', function() {
  showScreen('startScreen');

  // Event listeners
  document.getElementById('playBtn').addEventListener('click', function() {
    // Desbloquear audio primero
    unlockAudio();
    
    // Peque√±a demora para asegurar que el audio se desbloquee
    setTimeout(() => {
      playSound('tap');
      showTheory();
    }, 50);
  });

  document.getElementById('startGameBtn').addEventListener('click', function() {
    playSound('tap');
    startGame();
  });

  document.getElementById('backToMenuBtn').addEventListener('click', function() {
    playSound('tap');
    backToMenu();
  });

  // Audio unlock for mobile - intentar desbloquear en la primera interacci√≥n
  ['click', 'touchstart', 'keydown'].forEach(eventType => {
    document.addEventListener(eventType, function() {
      if (!audioUnlocked) {
        unlockAudio();
      }
    }, { once: true, passive: true });
  });
});
</script>
</body>
</html>